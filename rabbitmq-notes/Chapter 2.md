# 📘 Chapter 2: AMQP와 RabbitMQ 코드 작성하기

---

## 2.1 RPC 전송으로서의 AMQP

- RPC는 한 컴퓨터에서 다른 컴퓨터의 프로그램이나 프로그램 메서드를 원격에서 실행할 수 있게 해주는 컴퓨터 간의 통신 유형
  - 일반적으로 Client request -> Server response
- AMQP는 **request/response(RPC) 패턴**을 구현할 수 있는 메시징 프로토콜
  - Client request <-> Server response  
- 일반적인 RPC 호출처럼 보이지만, 실제로는 **비동기 메시지 기반**으로 동작  

---

## 2.2 AMQP의 RPC 프레임 구조

- RabbitMQ에서 AMQP 명령 전송 시 모든 인자들은 데이터 구조로 캡슐화된 프레임으로 인코딩돼 전송된다.
- AMQP 스펙
  - 헤더 프레임, 메소드 프레임, 콘텐츠 헤더 프레임, 바디 프레임, 하트비트 프레임 등
    - **헤더 프레임**은 RabbitMQ 연결 할 때 한 번 사용
    - **메소드 프레임**은 RabbitMQ와 서로 주고받는 RPC 요청이나 응답을 전달
    - **바디 프레임**은 메시지의 내용을 포함
    - 콘텐츠 헤더 프레임은 메시지의 크기와 속성을 포함
    - 하트비트 프레임은 RabbitMQ와 연결된 클라이언트와 서버가 주고받으며 서로 사용 가능한 상태인지 확인하는 데 사용됨

- 메시지를 프레임으로 미샬링
  - 미샬링이란?
    - 어떤 데이터를 전송 또는 저장 할 수 있는 형식으로 변환하는 과정
  - 프레임으로 미샬링?
    - 보내려는 메시지를 RabbitMQ로 보내기 위해 AMQP 프로토콜이 이해할 수 있는 형태로 바꾸는 과정 (대충 전송 가능한 형태로 가공한다는 말)  
  - 어떻게?
    - 메소드 프레임, 헤더 프레임, 바디 프레임 이 세가지로 나누어 미샬링함
    - 메소드 프레임
      - 어떤 작업을 하려는지 (exchange 명, routing key 등 정보 포함)
    - 헤더 프레임
      - 실제 메시지의 속성을 담음, 본문 크기 포함
    - 바디 프레임
      - 메시지 본문, 길이가 클 경우 여러 바디 프레임으로 구성      
---

## 2.3 프로토콜 사용하기

- 메시지를 큐에 발행하기 전에 최소한 익스체인지와 큐를 설정한 후 둘을 연결 해야한다.

### 메시지 발행
- 익스체인지를 Declare(선언) 할 때 발생하는 통신 절차
  - 클라이언트 Exchange.Declare -> 서버 Exchange.DeclareOk -> 클라이언트 ...
- 큐도 익스체인지를 생성한 후 유사한 통신 절차로 진행
  - 클라이언트 Queue.Declare -> 서버 Queue.DeclareOk -> 클라이언트 ...
  - 큐는 동일한 Queue.Declare 명령을 두 번 이상 전송해도 문제 없다. RabbitMQ는 중복된 큐 선언을 감지해 큐에 유용한 상태를 반환한다.
- 익스체인지와 큐를 연결
  - Queue.Bind 명령을 사용하여 **한 번에 하나의 큐만 지정**한다
  - 프레임 전송 방식은 큐와 유사하다.
- 위의 여러종류 프레임들이 서버로 전송하는 메시지의 데이터를 캡슐화한다.
  - 실제 메시지 본문을 RabbitMQ에 전달하기 전에 클라이언트는 메소드 프레임 ,콘텐츠 헤더 프레임, 하나 이상의 바디 프레임을 전송한다.
  - RabbitMQ에 존재하지 않는 익스체인지에 메시지를 발행하는 경우, 기본적으로 메시지는 자동으로 버려짐
- 하나의 메시지가 여러 목적지에 발행될 때, 인스턴스의 참조만 저장하므로 실제 메모리를 적게 사용하게 된다.
### 메시지 소비
- 소비자 애플리케이션은 Bais.Consume 명령으로 RabbitMQ의 큐를 구독한다.
- 서버는 Basic.ConsumeOK로 응답해 클라이언트가 메시지를 받을 준비를 하도록 한다.
- 소비자는 응답하기 적당한 형태인 메소드 프레임과 헤더 프레임, 바디프레임으로 메시지 전달 받는다.
---

## 2.4 파이썬으로 메시지 발행자 작성하기

---

## 2.5 RabbitMQ에서 메시지 받기
 
---

## 2.6 요약

- RPC 명령으로 RabbitMQ 서버와 클라이언트 간에 통신 프로토콜 정의
- 메시지 프레임 미샬링을 통해 프로토콜의 작동 방식 이해
- 클라이언트가 메시지를 발행하고 소비하기 위한 과정 이해

---

## 추가로 알아 보면 좋을 내용

